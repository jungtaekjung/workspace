<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="chattingMapper">

	<resultMap type="ChattingRoom" id="chattingRoom_rm">
      <id property="chattingNo" column="CHATTING_NO" />

      <result property="lastMessage" column="LAST_MESSAGE" />
      <result property="sendTime" column="SEND_TIME" />
      <result property="targetNo" column="TARGET_NO" />
      <result property="targetNickName" column="TARGET_NICKNAME" />
      <result property="targetProfile" column="TARGET_PROFILE" />
      <result property="notReadCount" column="NOT_READ_COUNT" />
   </resultMap>
   
   <!-- 채팅방 목록 조회 -->
   <select id="selectChattingRoomList" resultMap="chattingRoom_rm">
	   SELECT CHATTING_NO,
	
		   -- 1) 가장 최근 메세지 내용 조회
		   (SELECT MESSAGE_CONTENT FROM(
		      SELECT * FROM MESSAGE M
		      WHERE M.CHATTING_NO = R.CHATTING_NO 
		      ORDER BY MESSAGE_NO DESC)
		   WHERE ROWNUM = 1) LAST_MESSAGE,
		   
		   -- 2) 가장 최근 채팅 보낸 시간
		   (SELECT TO_CHAR(MAX(SEND_TIME), 'YYYY.MM.DD')  
		   FROM MESSAGE M
		   WHERE M.CHATTING_NO = R.CHATTING_NO) SEND_TIME,
		   
		   -- 3) 타겟 회원 번호
		   NVL2((SELECT OPEN_MEMBER FROM CHATTING_ROOM R2
		      WHERE R2.CHATTING_NO = R.CHATTING_NO 
		      AND OPEN_MEMBER = #{memberNo}),
		      PARTICIPANT,
		      OPEN_MEMBER) TARGET_NO,
		         
		   -- 4) 타겟 회원 닉네임
		   NVL2((SELECT OPEN_MEMBER FROM CHATTING_ROOM R2
		      WHERE R2.CHATTING_NO = R.CHATTING_NO 
		      AND OPEN_MEMBER = #{memberNo}),
		      (SELECT MEMBER_NICKNAME FROM MEMBER WHERE MEMBER_NO = R.PARTICIPANT),
		      (SELECT MEMBER_NICKNAME FROM MEMBER WHERE MEMBER_NO = R.OPEN_MEMBER)) TARGET_NICKNAME,
		      
		   -- 5) 타켓 프로필 이미지
		   NVL2((SELECT OPEN_MEMBER FROM CHATTING_ROOM R2
		      WHERE R2.CHATTING_NO = R.CHATTING_NO 
		      AND OPEN_MEMBER = #{memberNo}),
		      (SELECT PROFILE_IMG FROM MEMBER WHERE MEMBER_NO = R.PARTICIPANT),
		      (SELECT PROFILE_IMG FROM MEMBER WHERE MEMBER_NO = R.OPEN_MEMBER)) TARGET_PROFILE,
		      
		  	-- 6) 읽지 않은 받은 메세지 수
			(SELECT COUNT(*)
			FROM MESSAGE M
			WHERE READ_FL ='N'
		 	AND M.CHATTING_NO = R.CHATTING_NO
		    AND SENDER_NO !=#{memberNo}) NOT_READ_COUNT,
		      
		   (SELECT MAX(MESSAGE_NO) FROM MESSAGE M
			WHERE M.CHATTING_NO =R.CHATTING_NO) MAX_MESSAGE_NO
	   
		FROM CHATTING_ROOM R
		WHERE OPEN_MEMBER = #{memberNo}
		OR PARTICIPANT = #{memberNo}
		-- 8) 최근 메세지 순으로 정렬 + NULL 마지막으로 조회
		ORDER BY MAX_MESSAGE_NO DESC NULLS LAST
	   
   
   
   </select>
</mapper>
